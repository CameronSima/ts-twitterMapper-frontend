// Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

import { glGetDebugInfo } from 'luma.gl';
// Load shader chunks
// import SHADER_CHUNKS from '../../dist/shaderlib/shader-chunks';
import * as SHADER_CHUNKS from './shader-chunks';

export function checkRendererVendor(debugInfo, gpuVendor) {
  var vendor = debugInfo.vendor,
      renderer = debugInfo.renderer;

  var result = void 0;
  switch (gpuVendor) {
    case 'nvidia':
      result = vendor.match(/NVIDIA/i) || renderer.match(/NVIDIA/i);
      break;
    case 'intel':
      result = vendor.match(/INTEL/i) || renderer.match(/INTEL/i);
      break;
    case 'amd':
      result = vendor.match(/AMD/i) || renderer.match(/AMD/i) || vendor.match(/ATI/i) || renderer.match(/ATI/i);
      break;
    default:
      result = false;
  }
  return result;
}

export function getPlatformShaderDefines(gl) {
  /* eslint-disable */
  var platformDefines = '';
  var debugInfo = glGetDebugInfo(gl);

  if (checkRendererVendor(debugInfo, 'nvidia')) {
    platformDefines += '#define NVIDIA_GPU\n#define NVIDIA_FP64_WORKAROUND 1\n#define NVIDIA_EQUATION_WORKAROUND 1\n';
  } else if (checkRendererVendor(debugInfo, 'intel')) {
    platformDefines += '#define INTEL_GPU\n#define INTEL_FP64_WORKAROUND 1\n#define NVIDIA_EQUATION_WORKAROUND 1\n #define INTEL_TAN_WORKAROUND 1\n';
  } else if (checkRendererVendor(debugInfo, 'amd')) {
    platformDefines += '#define AMD_GPU\n';
  } else {
    platformDefines += '#define DEFAULT_GPU\n';
  }

  return platformDefines;
}

function assembleShader(gl) {
  var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var _opts = opts,
      vs = _opts.vs,
      _opts$project = _opts.project,
      project = _opts$project === undefined ? true : _opts$project,
      _opts$project2 = _opts.project64,
      project64 = _opts$project2 === undefined ? false : _opts$project2;
  var _opts2 = opts,
      _opts2$fp = _opts2.fp64,
      fp64 = _opts2$fp === undefined ? false : _opts2$fp;

  if (project64 === true) {
    fp64 = true;
  }
  var source = getPlatformShaderDefines(gl) + '\n';
  opts = Object.assign({}, opts, { project: project, project64: project64, fp64: fp64 });
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = Object.keys(SHADER_CHUNKS)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var chunkName = _step.value;

      if (opts[chunkName]) {
        source += SHADER_CHUNKS[chunkName].source + '\n';
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  var _iteratorNormalCompletion2 = true;
  var _didIteratorError2 = false;
  var _iteratorError2 = undefined;

  try {
    for (var _iterator2 = (opts.modules || [])[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
      var _chunkName = _step2.value;

      if (SHADER_CHUNKS[_chunkName]) {
        source += SHADER_CHUNKS[_chunkName].source + '\n';
      } else {
        throw new Error('Shader module ' + _chunkName + ' not found');
      }
    }
  } catch (err) {
    _didIteratorError2 = true;
    _iteratorError2 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion2 && _iterator2.return) {
        _iterator2.return();
      }
    } finally {
      if (_didIteratorError2) {
        throw _iteratorError2;
      }
    }
  }

  source += vs;
  return source;
}

export function assembleShaders(gl, opts) {
  var vsSource = assembleShader(gl, opts);
  var fsSource = opts.fs;

  // If shaderCache presents, output compiled shaders from luma.gl/shadeCache
  if (opts.shaderCache) {
    return {
      gl: gl,
      vs: opts.shaderCache.getVertexShader(gl, vsSource),
      fs: opts.shaderCache.getFragmentShader(gl, fsSource)
    };
  };
  // Otherwise just output shader source
  return {
    gl: gl,
    vs: vsSource,
    fs: fsSource
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zaGFkZXItdXRpbHMvYXNzZW1ibGUtc2hhZGVycy5qcyJdLCJuYW1lcyI6WyJnbEdldERlYnVnSW5mbyIsIlNIQURFUl9DSFVOS1MiLCJjaGVja1JlbmRlcmVyVmVuZG9yIiwiZGVidWdJbmZvIiwiZ3B1VmVuZG9yIiwidmVuZG9yIiwicmVuZGVyZXIiLCJyZXN1bHQiLCJtYXRjaCIsImdldFBsYXRmb3JtU2hhZGVyRGVmaW5lcyIsImdsIiwicGxhdGZvcm1EZWZpbmVzIiwiYXNzZW1ibGVTaGFkZXIiLCJvcHRzIiwidnMiLCJwcm9qZWN0IiwicHJvamVjdDY0IiwiZnA2NCIsInNvdXJjZSIsIk9iamVjdCIsImFzc2lnbiIsImtleXMiLCJjaHVua05hbWUiLCJtb2R1bGVzIiwiRXJyb3IiLCJhc3NlbWJsZVNoYWRlcnMiLCJ2c1NvdXJjZSIsImZzU291cmNlIiwiZnMiLCJzaGFkZXJDYWNoZSIsImdldFZlcnRleFNoYWRlciIsImdldEZyYWdtZW50U2hhZGVyIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxTQUFRQSxjQUFSLFFBQTZCLFNBQTdCO0FBQ0E7QUFDQTtBQUNBLE9BQU8sS0FBS0MsYUFBWixNQUErQixpQkFBL0I7O0FBRUEsT0FBTyxTQUFTQyxtQkFBVCxDQUE2QkMsU0FBN0IsRUFBd0NDLFNBQXhDLEVBQW1EO0FBQUEsTUFDakRDLE1BRGlELEdBQzdCRixTQUQ2QixDQUNqREUsTUFEaUQ7QUFBQSxNQUN6Q0MsUUFEeUMsR0FDN0JILFNBRDZCLENBQ3pDRyxRQUR5Qzs7QUFFeEQsTUFBSUMsZUFBSjtBQUNBLFVBQVFILFNBQVI7QUFDQSxTQUFLLFFBQUw7QUFDRUcsZUFBU0YsT0FBT0csS0FBUCxDQUFhLFNBQWIsS0FBMkJGLFNBQVNFLEtBQVQsQ0FBZSxTQUFmLENB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LFdBQVdkLEtBQUtlLEVBQXRCOztBQUVBO0FBQ0EsTUFBSWYsS0FBS2dCLFdBQVQsRUFBc0I7QUFDcEIsV0FBTztBQUNMbkIsWUFESztBQUVMSSxVQUFJRCxLQUFLZ0IsV0FBTCxDQUFpQkMsZUFBakIsQ0FBaUNwQixFQUFqQyxFQUFxQ2dCLFFBQXJDLENBRkM7QUFHTEUsVUFBSWYsS0FBS2dCLFdBQUwsQ0FBaUJFLGlCQUFqQixDQUFtQ3JCLEVBQW5DLEVBQXVDaUIsUUFBdkM7QUFIQyxLQUFQO0FBS0Q7QUFDRDtBQUNBLFNBQU87QUFDTGpCLFVBREs7QUFFTEksUUFBSVksUUFGQztBQUdMRSxRQUFJRDtBQUhDLEdBQVA7QUFLRCIsImZpbGUiOiJhc3NlbWJsZS1zaGFkZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE1IC0gMjAxNyBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7Z2xHZXREZWJ1Z0luZm99IGZyb20gJ2x1bWEuZ2wnO1xuLy8gTG9hZCBzaGFkZXIgY2h1bmtzXG4vLyBpbXBvcnQgU0hBREVSX0NIVU5LUyBmcm9tICcuLi8uLi9kaXN0L3NoYWRlcmxpYi9zaGFkZXItY2h1bmtzJztcbmltcG9ydCAqIGFzIFNIQURFUl9DSFVOS1MgZnJvbSAnLi9zaGFkZXItY2h1bmtzJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrUmVuZGVyZXJWZW5kb3IoZGVidWdJbmZvLCBncHVWZW5kb3IpIHtcbiAgY29uc3Qge3ZlbmRvciwgcmVuZGVyZXJ9ID0gZGVidWdJbmZvO1xuICBsZXQgcmVzdWx0O1xuICBzd2l0Y2ggKGdwdVZlbmRvcikge1xuICBjYXNlICdudmlkaWEnOlxuICAgIHJlc3VsdCA9IHZlbmRvci5tYXRjaCgvTlZJRElBL2kpIHx8IHJlbmRlcmVyLm1hdGNoKC9OVklESUEvaSk7XG4gICAgYnJlYWs7XG4gIGNhc2UgJ2ludGVsJzpcbiAgICByZXN1bHQgPSB2ZW5kb3IubWF0Y2goL0lOVEVML2kpIHx8IHJlbmRlcmVyLm1hdGNoKC9JTlRFTC9pKTtcbiAgICBicmVhaztcbiAgY2FzZSAnYW1kJzpcbiAgICByZXN1bHQgPVxuICAgICAgdmVuZG9yLm1hdGNoKC9BTUQvaSkgfHwgcmVuZGVyZXIubWF0Y2goL0FNRC9pKSB8fFxuICAgICAgdmVuZG9yLm1hdGNoKC9BVEkvaSkgfHwgcmVuZGVyZXIubWF0Y2goL0FUSS9pKTtcbiAgICBicmVhaztcbiAgZGVmYXVsdDpcbiAgICByZXN1bHQgPSBmYWxzZTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGxhdGZvcm1TaGFkZXJEZWZpbmVzKGdsKSB7XG4gIC8qIGVzbGludC1kaXNhYmxlICovXG4gIGxldCBwbGF0Zm9ybURlZmluZXMgPSAnJztcbiAgY29uc3QgZGVidWdJbmZvID0gZ2xHZXREZWJ1Z0luZm8oZ2wpO1xuXG4gIGlmIChjaGVja1JlbmRlcmVyVmVuZG9yKGRlYnVnSW5mbywgJ252aWRpYScpKSB7XG4gICAgcGxhdGZvcm1EZWZpbmVzICs9IGBcXFxuI2RlZmluZSBOVklESUFfR1BVXG4jZGVmaW5lIE5WSURJQV9GUDY0X1dPUktBUk9VTkQgMVxuI2RlZmluZSBOVklESUFfRVFVQVRJT05fV09SS0FST1VORCAxXG5gO1xuICB9IGVsc2UgaWYgKGNoZWNrUmVuZGVyZXJWZW5kb3IoZGVidWdJbmZvLCAnaW50ZWwnKSkge1xuICAgIHBsYXRmb3JtRGVmaW5lcyArPSBgXFxcbiNkZWZpbmUgSU5URUxfR1BVXG4jZGVmaW5lIElOVEVMX0ZQNjRfV09SS0FST1VORCAxXG4jZGVmaW5lIE5WSURJQV9FUVVBVElPTl9XT1JLQVJPVU5EIDFcXG4gXFxcbiNkZWZpbmUgSU5URUxfVEFOX1dPUktBUk9VTkQgMVxuYDtcbiAgfSBlbHNlIGlmIChjaGVja1JlbmRlcmVyVmVuZG9yKGRlYnVnSW5mbywgJ2FtZCcpKSB7XG4gICAgcGxhdGZvcm1EZWZpbmVzICs9IGBcXFxuI2RlZmluZSBBTURfR1BVXG5gO1xuICB9IGVsc2Uge1xuICAgIHBsYXRmb3JtRGVmaW5lcyArPSBgXFxcbiNkZWZpbmUgREVGQVVMVF9HUFVcbmA7XG4gIH1cblxuICByZXR1cm4gcGxhdGZvcm1EZWZpbmVzO1xufVxuXG5mdW5jdGlvbiBhc3NlbWJsZVNoYWRlcihnbCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHt2cywgcHJvamVjdCA9IHRydWUsIHByb2plY3Q2NCA9IGZhbHNlfSA9IG9wdHM7XG4gIGxldCB7ZnA2NCA9IGZhbHNlfSA9IG9wdHM7XG4gIGlmIChwcm9qZWN0NjQgPT09IHRydWUpIHtcbiAgICBmcDY0ID0gdHJ1ZTtcbiAgfVxuICBsZXQgc291cmNlID0gYCR7Z2V0UGxhdGZvcm1TaGFkZXJEZWZpbmVzKGdsKX1cXG5gO1xuICBvcHRzID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0cywge3Byb2plY3QsIHByb2plY3Q2NCwgZnA2NH0pO1xuICBmb3IgKGNvbnN0IGNodW5rTmFtZSBvZiBPYmplY3Qua2V5cyhTSEFERVJfQ0hVTktTKSkge1xuICAgIGlmIChvcHRzW2NodW5rTmFtZV0pIHtcbiAgICAgIHNvdXJjZSArPSBgJHtTSEFERVJfQ0hVTktTW2NodW5rTmFtZV0uc291cmNlfVxcbmA7XG4gICAgfVxuICB9XG4gIGZvciAoY29uc3QgY2h1bmtOYW1lIG9mIG9wdHMubW9kdWxlcyB8fCBbXSkge1xuICAgIGlmIChTSEFERVJfQ0hVTktTW2NodW5rTmFtZV0pIHtcbiAgICAgIHNvdXJjZSArPSBgJHtTSEFERVJfQ0hVTktTW2NodW5rTmFtZV0uc291cmNlfVxcbmA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgU2hhZGVyIG1vZHVsZSAke2NodW5rTmFtZX0gbm90IGZvdW5kYCk7XG4gICAgfVxuICB9XG4gIHNvdXJjZSArPSB2cztcbiAgcmV0dXJuIHNvdXJjZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc2VtYmxlU2hhZGVycyhnbCwgb3B0cykge1xuICBjb25zdCB2c1NvdXJjZSA9IGFzc2VtYmxlU2hhZGVyKGdsLCBvcHRzKTtcbiAgY29uc3QgZnNTb3VyY2UgPSBvcHRzLmZzO1xuXG4gIC8vIElmIHNoYWRlckNhY2hlIHByZXNlbnRzLCBvdXRwdXQgY29tcGlsZWQgc2hhZGVycyBmcm9tIGx1bWEuZ2wvc2hhZGVDYWNoZVxuICBpZiAob3B0cy5zaGFkZXJDYWNoZSkge1xuICAgIHJldHVybiB7XG4gICAgICBnbCxcbiAgICAgIHZzOiBvcHRzLnNoYWRlckNhY2hlLmdldFZlcnRleFNoYWRlcihnbCwgdnNTb3VyY2UpLFxuICAgICAgZnM6IG9wdHMuc2hhZGVyQ2FjaGUuZ2V0RnJhZ21lbnRTaGFkZXIoZ2wsIGZzU291cmNlKVxuICAgIH1cbiAgfTtcbiAgLy8gT3RoZXJ3aXNlIGp1c3Qgb3V0cHV0IHNoYWRlciBzb3VyY2VcbiAgcmV0dXJuIHtcbiAgICBnbCxcbiAgICB2czogdnNTb3VyY2UsXG4gICAgZnM6IGZzU291cmNlXG4gIH1cbn1cbiJdfQ==