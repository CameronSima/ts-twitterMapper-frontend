var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/* global window */
import { Component, PropTypes, createElement } from 'react';
import { PerspectiveViewport } from 'deck.gl';
import { vec3 } from 'gl-matrix';

/* Utils */

// constrain number between bounds
function clamp(x, min, max) {
  if (x < min) {
    return min;
  }
  if (x > max) {
    return max;
  }
  return x;
}

var ua = typeof window.navigator !== 'undefined' ? window.navigator.userAgent.toLowerCase() : '';
var firefox = ua.indexOf('firefox') !== -1;

var propTypes = {
  // target position
  lookAt: PropTypes.arrayOf(PropTypes.number),
  // camera distance
  distance: PropTypes.number.isRequired,
  minDistance: PropTypes.number,
  maxDistance: PropTypes.number,
  // rotation
  rotationX: PropTypes.number,
  rotationY: PropTypes.number,
  // field of view
  fov: PropTypes.number,
  // viewport width in pixels
  width: PropTypes.number.isRequired,
  // viewport height in pixels
  height: PropTypes.number.isRequired,
  // callback
  onViewportChange: PropTypes.func.isRequired
};

var defaultProps = {
  lookAt: [0, 0, 0],
  rotationX: 0,
  rotationY: 0,
  minDistance: 0,
  maxDistance: Infinity,
  fov: 50
};

var OrbitController = function (_Component) {
  _inherits(OrbitController, _Component);

  _createClass(OrbitController, null, [{
    key: 'getViewport',
    value: function getViewport(_ref) {
      var width = _ref.width,
          height = _ref.height,
          lookAt = _ref.lookAt,
          distance = _ref.distance,
          rotationX = _ref.rotationX,
          rotationY = _ref.rotationY,
          fov = _ref.fov;

      var cameraPos = vec3.add([], lookAt, [0, 0, distance]);
      vec3.rotateX(cameraPos, cameraPos, lookAt, rotationX / 180 * Math.PI);
      vec3.rotateY(cameraPos, cameraPos, lookAt, rotationY / 180 * Math.PI);

      return new PerspectiveViewport({
        width: width,
        height: height,
        lookAt: lookAt,
        far: 1000,
        near: 0.1,
        fovy: fov,
        eye: cameraPos
      });
    }
  }]);

  function OrbitController(props) {
    _classCallCheck(this, OrbitController);

    var _this = _possibleConstructorReturn(this, (OrbitController.__proto__ || Object.getPrototypeOf(OrbitController)).call(this, props));

    _this._dragStartPos = null;
    return _this;
  }

  _createClass(OrbitController, [{
    key: '_onDragStart',
    value: function _onDragStart(evt) {
      var pageX = evt.pageX,
          pageY = evt.pageY;

      this._dragStartPos = [pageX, pageY];
      this.props.onViewportChange({ isDragging: true });
    }
  }, {
    key: '_onDrag',
    value: function _onDrag(evt) {
      if (this._dragStartPos) {
        var pageX = evt.pageX,
            pageY = evt.pageY;
        var _props = this.props,
            width = _props.width,
            height = _props.height;

        var dx = (pageX - this._dragStartPos[0]) / width;
        var dy = (pageY - this._dragStartPos[1]) / height;

        if (evt.shiftKey || evt.ctrlKey || evt.altKey || evt.metaKey) {
          // pan
          var _props2 = this.props,
              lookAt = _props2.lookAt,
              distance = _props2.distance,
              rotationX = _props2.rotationX,
              rotationY = _props2.rotationY,
              fov = _props2.fov;


          var unitsPerPixel = distance / Math.tan(fov / 180 * Math.PI / 2) / 2;

          var newLookAt = vec3.add([], lookAt, [-unitsPerPixel * dx, unitsPerPixel * dy, 0]);
          vec3.rotateX(newLookAt, newLookAt, lookAt, rotationX / 180 * Math.PI);
          vec3.rotateY(newLookAt, newLookAt, lookAt, rotationY / 180 * Math.PI);

          this.props.onViewportChange({
            lookAt: newLookAt
          });
        } else {
          // rotate
          var _props3 = this.props,
              _rotationX = _props3.rotationX,
              _rotationY = _props3.rotationY;

          var newRotationX = clamp(_rotationX - dy * 180, -90, 90);
          var newRotationY = (_rotationY - dx * 180) % 360;

          this.props.onViewportChange({
            rotationX: newRotationX,
            rotationY: newRotationY
          });
        }

        this._dragStartPos = [pageX, pageY];
      }
    }
  }, {
    key: '_onDragEnd',
    value: function _onDragEnd() {
      this._dragStartPos = null;
      this.props.onViewportChange({ isDragging: false });
    }
  }, {
    key: '_onWheel',
    value: function _onWheel(evt) {
      evt.preventDefault();
      var value = evt.deltaY;
      // Firefox doubles the values on retina screens...
      if (firefox && evt.deltaMode === window.WheelEvent.DOM_DELTA_PIXEL) {
        value /= window.devicePixelRatio;
      }
      if (evt.deltaMode === window.WheelEvent.DOM_DELTA_LINE) {
        value *= 40;
      }
      if (value !== 0 && value % 4.000244140625 === 0) {
        // This one is definitely a mouse wheel event.
        // Normalize this value to match trackpad.
        value = Math.floor(value / 4);
      }

      var _props4 = this.props,
          distance = _props4.distance,
          minDistance = _props4.minDistance,
          maxDistance = _props4.maxDistance;

      var newDistance = clamp(distance * Math.pow(1.01, value), minDistance, maxDistance);

      this.props.onViewportChange({
        distance: newDistance
      });
    }

    // public API

  }, {
    key: 'fitBounds',
    value: function fitBounds(min, max) {
      var fov = this.props.fov;

      var size = Math.max(max[0] - min[0], max[1] - min[1], max[2] - min[2]);
      var newDistance = size / Math.tan(fov / 180 * Math.PI / 2) / 2;

      this.props.onViewportChange({
        distance: newDistance
      });
    }
  }, {
    key: 'render',
    value: function render() {
      return createElement('div', {
        style: { position: 'relative', userSelect: 'none' },
        onMouseDown: this._onDragStart.bind(this),
        onMouseMove: this._onDrag.bind(this),
        onMouseLeave: this._onDragEnd.bind(this),
        onMouseUp: this._onDragEnd.bind(this),
        onWheel: this._onWheel.bind(this),
        children: this.props.children
      });
    }
  }]);

  return OrbitController;
}(Component);

export default OrbitController;


OrbitController.propTypes = propTypes;
OrbitController.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9vcmJpdC1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbXBvbmVudCIsIlByb3BUeXBlcyIsImNyZWF0ZUVsZW1lbnQiLCJQZXJzcGVjdGl2ZVZpZXdwb3J0IiwidmVjMyIsImNsYW1wIiwieCIsIm1pbiIsIm1heCIsInVhIiwid2luZG93IiwibmF2aWdhdG9yIiwidXNlckFnZW50IiwidG9Mb3dlckNhc2UiLCJmaXJlZm94IiwiaW5kZXhPZiIsInByb3BUeXBlcyIsImxvb2tBdCIsImFycmF5T2YiLCJudW1iZXIiLCJkaXN0YW5jZSIsImlzUmVxdWlyZWQiLCJtaW5EaXN0YW5jZSIsIm1heERpc3RhbmNlIiwicm90YXRpb25YIiwicm90YXRpb25ZIiwiZm92Iiwid2lkdGgiLCJoZWlnaHQiLCJvblZpZXdwb3J0Q2hhbmdlIiwiZnVuYyIsImRlZmF1bHRQcm9wcyIsIkluZmluaXR5IiwiT3JiaXRDb250cm9sbGVyIiwiY2FtZXJhUG9zIiwiYWRkIiwicm90YXRlWCIsIk1hdGgiLCJQSSIsInJvdGF0ZVkiLCJmYXIiLCJuZWFyIiwiZm92eSIsImV5ZSIsInByb3BzIiwiX2RyYWdTdGFydFBvcyIsImV2dCIsInBhZ2VYIiwicGFnZVkiLCJpc0RyYWdnaW5nIiwiZHgiLCJkeSIsInNoaWZ0S2V5IiwiY3RybEtleSIsImFsdEtleSIsIm1ldGFLZXkiLCJ1bml0c1BlclBpeGVsIiwidGFuIiwibmV3TG9va0F0IiwibmV3Um90YXRpb25YIiwibmV3Um90YXRpb25ZIiwicHJldmVudERlZmF1bHQiLCJ2YWx1ZSIsImRlbHRhWSIsImRlbHRhTW9kZSIsIldoZWVsRXZlbnQiLCJET01fREVMVEFfUElYRUwiLCJkZXZpY2VQaXhlbFJhdGlvIiwiRE9NX0RFTFRBX0xJTkUiLCJmbG9vciIsIm5ld0Rpc3RhbmNlIiwicG93Iiwic2l6ZSIsInN0eWxlIiwicG9zaXRpb24iLCJ1c2VyU2VsZWN0Iiwib25Nb3VzZURvd24iLCJfb25EcmFnU3RhcnQiLCJiaW5kIiwib25Nb3VzZU1vdmUiLCJfb25EcmFnIiwib25Nb3VzZUxlYXZlIiwiX29uRHJhZ0VuZCIsIm9uTW91c2VVcCIsIm9uV2hlZWwiLCJfb25XaGVlbCIsImNoaWxkcmVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBQ0EsU0FBUUEsU0FBUixFQUFtQkMsU0FBbkIsRUFBOEJDLGFBQTlCLFFBQWtELE9BQWxEO0FBQ0EsU0FBUUMsbUJBQVIsUUFBa0MsU0FBbEM7QUFDQSxTQUFRQyxJQUFSLFFBQW1CLFdBQW5COztBQUVBOztBQUVBO0FBQ0EsU0FBU0MsS0FBVCxDQUFlQyxDQUFmLEVBQWtCQyxHQUFsQixFQUF1QkMsR0FBdkIsRUFBNEI7QUFDMUIsTUFBSUYsSUFBSUMsR0FBUixFQUFhO0FBQ1gsV0FBT0EsR0FBUDtBQUNEO0FBQ0QsTUFBSUQsSUFBSUUsR0FBUixFQUFhO0FBQ1gsV0FBT0EsR0FBUDtBQUNEO0FBQ0QsU0FBT0YsQ0FBUDtBQUNEOztBQUVELElBQU1HLEtBQUssT0FBT0MsT0FBT0MsU0FBZCxLQUE0QixXQUE1QixHQUNURCxPQUFPQyxTQUFQLENBQWlCQyxTQUFqQixDQUEyQkMsV0FBM0IsRUFEUyxHQUNrQyxFQUQ3QztBQUVBLElBQU1DLFVBQVVMLEdBQUdNLE9BQUgsQ0FBVyxTQUFYLE1BQTBCLENBQUMsQ0FBM0M7O0FBRUEsSUFBTUMsWUFBWTtBQUNoQjtBQUNBQyxVQUFRaEIsVUFBVWlCLE9BQVYsQ0FBa0JqQixVQUFVa0IsTUFBNUIsQ0FGUTtBQUdoQjtBQUNBQyxZQUFVbkIsVUFBVWtCLE1BQVYsQ0FBaUJFLFVBSlg7QUFLaEJDLGVBQWFyQixVQUFVa0IsTUFMUDtBQU1oQkksZUFBYXRCLFVBQVVrQixNQU5QO0FBT2hCO0FBQ0FLLGFBQVd2QixVQUFVa0IsTUFSTDtBQVNoQk0sYUFBV3hCLFVBQVVrQixNQVRMO0FBVWhCO0FBQ0FPLE9BQUt6QixVQUFVa0IsTUFYQztBQVloQjtBQUNBUSxTQUFPMUIsVUFBVWtCLE1BQVYsQ0FBaUJFLFVBYlI7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QUFMLENBQVNBLElBQUksQ0FBSixJQUFTRCxJQUFJLENBQUosQ0FBbEIsRUFBMEJDLElBQUksQ0FBSixJQUFTRCxJQUFJLENBQUosQ0FBbkMsRUFBMkNDLElBQUksQ0FBSixJQUFTRCxJQUFJLENBQUosQ0FBcEQsQ0FBYjtBQUNBLFVBQU0rRCxjQUFjRSxPQUFPbkMsS0FBS29CLEdBQUwsQ0FBUy9CLE1BQU0sR0FBTixHQUFZVyxLQUFLQyxFQUFqQixHQUFzQixDQUEvQixDQUFQLEdBQTJDLENBQS9EOztBQUVBLFdBQUtNLEtBQUwsQ0FBV2YsZ0JBQVgsQ0FBNEI7QUFDMUJULGtCQUFVa0Q7QUFEZ0IsT0FBNUI7QUFHRDs7OzZCQUVRO0FBQ1AsYUFBT3BFLGNBQWMsS0FBZCxFQUFxQjtBQUMxQnVFLGVBQU8sRUFBQ0MsVUFBVSxVQUFYLEVBQXVCQyxZQUFZLE1BQW5DLEVBRG1CO0FBRTFCQyxxQkFBYSxLQUFLQyxZQUFMLENBQWtCQyxJQUFsQixDQUF1QixJQUF2QixDQUZhO0FBRzFCQyxxQkFBYSxLQUFLQyxPQUFMLENBQWFGLElBQWIsQ0FBa0IsSUFBbEIsQ0FIYTtBQUkxQkcsc0JBQWMsS0FBS0MsVUFBTCxDQUFnQkosSUFBaEIsQ0FBcUIsSUFBckIsQ0FKWTtBQUsxQkssbUJBQVcsS0FBS0QsVUFBTCxDQUFnQkosSUFBaEIsQ0FBcUIsSUFBckIsQ0FMZTtBQU0xQk0saUJBQVMsS0FBS0MsUUFBTCxDQUFjUCxJQUFkLENBQW1CLElBQW5CLENBTmlCO0FBTzFCUSxrQkFBVSxLQUFLMUMsS0FBTCxDQUFXMEM7QUFQSyxPQUFyQixDQUFQO0FBU0Q7Ozs7RUFuSDBDdEYsUzs7ZUFBeEJpQyxlOzs7QUFzSHJCQSxnQkFBZ0JqQixTQUFoQixHQUE0QkEsU0FBNUI7QUFDQWlCLGdCQUFnQkYsWUFBaEIsR0FBK0JBLFlBQS9CIiwiZmlsZSI6Im9yYml0LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgd2luZG93ICovXG5pbXBvcnQge0NvbXBvbmVudCwgUHJvcFR5cGVzLCBjcmVhdGVFbGVtZW50fSBmcm9tICdyZWFjdCc7XG5pbXBvcnQge1BlcnNwZWN0aXZlVmlld3BvcnR9IGZyb20gJ2RlY2suZ2wnO1xuaW1wb3J0IHt2ZWMzfSBmcm9tICdnbC1tYXRyaXgnO1xuXG4vKiBVdGlscyAqL1xuXG4vLyBjb25zdHJhaW4gbnVtYmVyIGJldHdlZW4gYm91bmRzXG5mdW5jdGlvbiBjbGFtcCh4LCBtaW4sIG1heCkge1xuICBpZiAoeCA8IG1pbikge1xuICAgIHJldHVybiBtaW47XG4gIH1cbiAgaWYgKHggPiBtYXgpIHtcbiAgICByZXR1cm4gbWF4O1xuICB9XG4gIHJldHVybiB4O1xufVxuXG5jb25zdCB1YSA9IHR5cGVvZiB3aW5kb3cubmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyA/XG4gIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkgOiAnJztcbmNvbnN0IGZpcmVmb3ggPSB1YS5pbmRleE9mKCdmaXJlZm94JykgIT09IC0xO1xuXG5jb25zdCBwcm9wVHlwZXMgPSB7XG4gIC8vIHRhcmdldCBwb3NpdGlvblxuICBsb29rQXQ6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5udW1iZXIpLFxuICAvLyBjYW1lcmEgZGlzdGFuY2VcbiAgZGlzdGFuY2U6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcbiAgbWluRGlzdGFuY2U6IFByb3BUeXBlcy5udW1iZXIsXG4gIG1heERpc3RhbmNlOiBQcm9wVHlwZXMubnVtYmVyLFxuICAvLyByb3RhdGlvblxuICByb3RhdGlvblg6IFByb3BUeXBlcy5udW1iZXIsXG4gIHJvdGF0aW9uWTogUHJvcFR5cGVzLm51bWJlcixcbiAgLy8gZmllbGQgb2Ygdmlld1xuICBmb3Y6IFByb3BUeXBlcy5udW1iZXIsXG4gIC8vIHZpZXdwb3J0IHdpZHRoIGluIHBpeGVsc1xuICB3aWR0aDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuICAvLyB2aWV3cG9ydCBoZWlnaHQgaW4gcGl4ZWxzXG4gIGhlaWdodDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuICAvLyBjYWxsYmFja1xuICBvblZpZXdwb3J0Q2hhbmdlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkXG59O1xuXG5jb25zdCBkZWZhdWx0UHJvcHMgPSB7XG4gIGxvb2tBdDogWzAsIDAsIDBdLFxuICByb3RhdGlvblg6IDAsXG4gIHJvdGF0aW9uWTogMCxcbiAgbWluRGlzdGFuY2U6IDAsXG4gIG1heERpc3RhbmNlOiBJbmZpbml0eSxcbiAgZm92OiA1MFxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT3JiaXRDb250cm9sbGVyIGV4dGVuZHMgQ29tcG9uZW50IHtcblxuICBzdGF0aWMgZ2V0Vmlld3BvcnQoe3dpZHRoLCBoZWlnaHQsIGxvb2tBdCwgZGlzdGFuY2UsIHJvdGF0aW9uWCwgcm90YXRpb25ZLCBmb3Z9KSB7XG4gICAgY29uc3QgY2FtZXJhUG9zID0gdmVjMy5hZGQoW10sIGxvb2tBdCwgWzAsIDAsIGRpc3RhbmNlXSk7XG4gICAgdmVjMy5yb3RhdGVYKGNhbWVyYVBvcywgY2FtZXJhUG9zLCBsb29rQXQsIHJvdGF0aW9uWCAvIDE4MCAqIE1hdGguUEkpO1xuICAgIHZlYzMucm90YXRlWShjYW1lcmFQb3MsIGNhbWVyYVBvcywgbG9va0F0LCByb3RhdGlvblkgLyAxODAgKiBNYXRoLlBJKTtcblxuICAgIHJldHVybiBuZXcgUGVyc3BlY3RpdmVWaWV3cG9ydCh7XG4gICAgICB3aWR0aCxcbiAgICAgIGhlaWdodCxcbiAgICAgIGxvb2tBdCxcbiAgICAgIGZhcjogMTAwMCxcbiAgICAgIG5lYXI6IDAuMSxcbiAgICAgIGZvdnk6IGZvdixcbiAgICAgIGV5ZTogY2FtZXJhUG9zXG4gICAgfSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLl9kcmFnU3RhcnRQb3MgPSBudWxsO1xuICB9XG5cbiAgX29uRHJhZ1N0YXJ0KGV2dCkge1xuICAgIGNvbnN0IHtwYWdlWCwgcGFnZVl9ID0gZXZ0O1xuICAgIHRoaXMuX2RyYWdTdGFydFBvcyA9IFtwYWdlWCwgcGFnZVldO1xuICAgIHRoaXMucHJvcHMub25WaWV3cG9ydENoYW5nZSh7aXNEcmFnZ2luZzogdHJ1ZX0pO1xuICB9XG5cbiAgX29uRHJhZyhldnQpIHtcbiAgICBpZiAodGhpcy5fZHJhZ1N0YXJ0UG9zKSB7XG4gICAgICBjb25zdCB7cGFnZVgsIHBhZ2VZfSA9IGV2dDtcbiAgICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IHRoaXMucHJvcHM7XG4gICAgICBjb25zdCBkeCA9IChwYWdlWCAtIHRoaXMuX2RyYWdTdGFydFBvc1swXSkgLyB3aWR0aDtcbiAgICAgIGNvbnN0IGR5ID0gKHBhZ2VZIC0gdGhpcy5fZHJhZ1N0YXJ0UG9zWzFdKSAvIGhlaWdodDtcblxuICAgICAgaWYgKGV2dC5zaGlmdEtleSB8fCBldnQuY3RybEtleSB8fCBldnQuYWx0S2V5IHx8IGV2dC5tZXRhS2V5KSB7XG4gICAgICAgIC8vIHBhblxuICAgICAgICBjb25zdCB7bG9va0F0LCBkaXN0YW5jZSwgcm90YXRpb25YLCByb3RhdGlvblksIGZvdn0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGNvbnN0IHVuaXRzUGVyUGl4ZWwgPSBkaXN0YW5jZSAvIE1hdGgudGFuKGZvdiAvIDE4MCAqIE1hdGguUEkgLyAyKSAvIDI7XG5cbiAgICAgICAgY29uc3QgbmV3TG9va0F0ID0gdmVjMy5hZGQoW10sIGxvb2tBdCwgWy11bml0c1BlclBpeGVsICogZHgsIHVuaXRzUGVyUGl4ZWwgKiBkeSwgMF0pO1xuICAgICAgICB2ZWMzLnJvdGF0ZVgobmV3TG9va0F0LCBuZXdMb29rQXQsIGxvb2tBdCwgcm90YXRpb25YIC8gMTgwICogTWF0aC5QSSk7XG4gICAgICAgIHZlYzMucm90YXRlWShuZXdMb29rQXQsIG5ld0xvb2tBdCwgbG9va0F0LCByb3RhdGlvblkgLyAxODAgKiBNYXRoLlBJKTtcblxuICAgICAgICB0aGlzLnByb3BzLm9uVmlld3BvcnRDaGFuZ2Uoe1xuICAgICAgICAgIGxvb2tBdDogbmV3TG9va0F0XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gcm90YXRlXG4gICAgICAgIGNvbnN0IHtyb3RhdGlvblgsIHJvdGF0aW9uWX0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBuZXdSb3RhdGlvblggPSBjbGFtcChyb3RhdGlvblggLSBkeSAqIDE4MCwgLTkwLCA5MCk7XG4gICAgICAgIGNvbnN0IG5ld1JvdGF0aW9uWSA9IChyb3RhdGlvblkgLSBkeCAqIDE4MCkgJSAzNjA7XG5cbiAgICAgICAgdGhpcy5wcm9wcy5vblZpZXdwb3J0Q2hhbmdlKHtcbiAgICAgICAgICByb3RhdGlvblg6IG5ld1JvdGF0aW9uWCxcbiAgICAgICAgICByb3RhdGlvblk6IG5ld1JvdGF0aW9uWVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fZHJhZ1N0YXJ0UG9zID0gW3BhZ2VYLCBwYWdlWV07XG4gICAgfVxuICB9XG5cbiAgX29uRHJhZ0VuZCgpIHtcbiAgICB0aGlzLl9kcmFnU3RhcnRQb3MgPSBudWxsO1xuICAgIHRoaXMucHJvcHMub25WaWV3cG9ydENoYW5nZSh7aXNEcmFnZ2luZzogZmFsc2V9KTtcbiAgfVxuXG4gIF9vbldoZWVsKGV2dCkge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGxldCB2YWx1ZSA9IGV2dC5kZWx0YVk7XG4gICAgLy8gRmlyZWZveCBkb3VibGVzIHRoZSB2YWx1ZXMgb24gcmV0aW5hIHNjcmVlbnMuLi5cbiAgICBpZiAoZmlyZWZveCAmJiBldnQuZGVsdGFNb2RlID09PSB3aW5kb3cuV2hlZWxFdmVudC5ET01fREVMVEFfUElYRUwpIHtcbiAgICAgIHZhbHVlIC89IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgIH1cbiAgICBpZiAoZXZ0LmRlbHRhTW9kZSA9PT0gd2luZG93LldoZWVsRXZlbnQuRE9NX0RFTFRBX0xJTkUpIHtcbiAgICAgIHZhbHVlICo9IDQwO1xuICAgIH1cbiAgICBpZiAodmFsdWUgIT09IDAgJiYgdmFsdWUgJSA0LjAwMDI0NDE0MDYyNSA9PT0gMCkge1xuICAgICAgLy8gVGhpcyBvbmUgaXMgZGVmaW5pdGVseSBhIG1vdXNlIHdoZWVsIGV2ZW50LlxuICAgICAgLy8gTm9ybWFsaXplIHRoaXMgdmFsdWUgdG8gbWF0Y2ggdHJhY2twYWQuXG4gICAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUgLyA0KTtcbiAgICB9XG5cbiAgICBjb25zdCB7ZGlzdGFuY2UsIG1pbkRpc3RhbmNlLCBtYXhEaXN0YW5jZX0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IG5ld0Rpc3RhbmNlID0gY2xhbXAoZGlzdGFuY2UgKiBNYXRoLnBvdygxLjAxLCB2YWx1ZSksIG1pbkRpc3RhbmNlLCBtYXhEaXN0YW5jZSk7XG5cbiAgICB0aGlzLnByb3BzLm9uVmlld3BvcnRDaGFuZ2Uoe1xuICAgICAgZGlzdGFuY2U6IG5ld0Rpc3RhbmNlXG4gICAgfSk7XG4gIH1cblxuICAvLyBwdWJsaWMgQVBJXG4gIGZpdEJvdW5kcyhtaW4sIG1heCkge1xuICAgIGNvbnN0IHtmb3Z9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBzaXplID0gTWF0aC5tYXgobWF4WzBdIC0gbWluWzBdLCBtYXhbMV0gLSBtaW5bMV0sIG1heFsyXSAtIG1pblsyXSk7XG4gICAgY29uc3QgbmV3RGlzdGFuY2UgPSBzaXplIC8gTWF0aC50YW4oZm92IC8gMTgwICogTWF0aC5QSSAvIDIpIC8gMjtcblxuICAgIHRoaXMucHJvcHMub25WaWV3cG9ydENoYW5nZSh7XG4gICAgICBkaXN0YW5jZTogbmV3RGlzdGFuY2VcbiAgICB9KTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gY3JlYXRlRWxlbWVudCgnZGl2Jywge1xuICAgICAgc3R5bGU6IHtwb3NpdGlvbjogJ3JlbGF0aXZlJywgdXNlclNlbGVjdDogJ25vbmUnfSxcbiAgICAgIG9uTW91c2VEb3duOiB0aGlzLl9vbkRyYWdTdGFydC5iaW5kKHRoaXMpLFxuICAgICAgb25Nb3VzZU1vdmU6IHRoaXMuX29uRHJhZy5iaW5kKHRoaXMpLFxuICAgICAgb25Nb3VzZUxlYXZlOiB0aGlzLl9vbkRyYWdFbmQuYmluZCh0aGlzKSxcbiAgICAgIG9uTW91c2VVcDogdGhpcy5fb25EcmFnRW5kLmJpbmQodGhpcyksXG4gICAgICBvbldoZWVsOiB0aGlzLl9vbldoZWVsLmJpbmQodGhpcyksXG4gICAgICBjaGlsZHJlbjogdGhpcy5wcm9wcy5jaGlsZHJlblxuICAgIH0pO1xuICB9XG59XG5cbk9yYml0Q29udHJvbGxlci5wcm9wVHlwZXMgPSBwcm9wVHlwZXM7XG5PcmJpdENvbnRyb2xsZXIuZGVmYXVsdFByb3BzID0gZGVmYXVsdFByb3BzO1xuIl19