'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _lib = require('../../../lib');

var _gridCellLayer = require('../grid-cell-layer/grid-cell-layer');

var _gridCellLayer2 = _interopRequireDefault(_gridCellLayer);

var _gridAggregator = require('./grid-aggregator');

var _scaleUtils = require('../../../utils/scale-utils');

var _colorUtils = require('../../../utils/color-utils');

var _binSorter = require('../../../utils/bin-sorter');

var _binSorter2 = _interopRequireDefault(_binSorter);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } // Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

var defaultProps = {
  cellSize: 1000,
  colorRange: _colorUtils.defaultColorRange,
  colorDomain: null,
  elevationRange: [0, 1000],
  elevationDomain: null,
  elevationScale: 1,
  lowerPercentile: 0,
  upperPercentile: 100,
  coverage: 1,
  getPosition: function getPosition(x) {
    return x.position;
  },
  getColorValue: function getColorValue(points) {
    return points.length;
  },
  extruded: false,
  fp64: false,
  // Optional settings for 'lighting' shader module
  lightSettings: {
    lightsPosition: [-122.45, 37.75, 8000, -122.0, 38.00, 5000],
    ambientRatio: 0.05,
    diffuseRatio: 0.6,
    specularRatio: 0.8,
    lightsStrength: [2.0, 0.0, 0.0, 0.0],
    numberOfLights: 2
  }
};

function _needsReProjectPoints(oldProps, props) {
  return oldProps.cellSize !== props.cellSize;
}

function _percentileChanged(oldProps, props) {
  return oldProps.lowerPercentile !== props.lowerPercentile || oldProps.upperPercentile !== props.upperPercentile;
}

function _needsReSortBins(oldProps, props) {
  return oldProps.getColorValue !== props.getColorValue;
}

var GridLayer = function (_CompositeLayer) {
  _inherits(GridLayer, _CompositeLayer);

  function GridLayer() {
    _classCallCheck(this, GridLayer);

    return _possibleConstructorReturn(this, (GridLayer.__proto__ || Object.getPrototypeOf(GridLayer)).apply(this, arguments));
  }

  _createClass(GridLayer, [{
    key: 'initializeState',
    value: function initializeState() {
      this.state = {
        layerData: [],
        sortedBins: null,
        valueDomain: null
      };
    }
  }, {
    key: 'updateState',
    value: function updateState(_ref) {
      var oldProps = _ref.oldProps,
          props = _ref.props,
          changeFlags = _ref.changeFlags;

      if (changeFlags.dataChanged || _needsReProjectPoints(oldProps, props)) {
        // project data into hexagons, and get sortedBins
        this.getLayerData();
        this.getSortedBins();

        // this needs sortedBins to be set
        this.getValueDomain();
      } else if (_needsReSortBins(oldProps, props)) {

        this.getSortedBins();
        this.getValueDomain();
      } else if (_percentileChanged(oldProps, props)) {

        this.getValueDomain();
      }
    }
  }, {
    key: 'getLayerData',
    value: function getLayerData() {
      var _props = this.props,
          data = _props.data,
          cellSize = _props.cellSize,
          getPosition = _props.getPosition;

      var _pointToDensityGridDa = (0, _gridAggregator.pointToDensityGridData)(data, cellSize, getPosition),
          layerData = _pointToDensityGridDa.layerData;

      this.setState({ layerData: layerData });
    }
  }, {
    key: 'getSortedBins',
    value: function getSortedBins() {
      var sortedBins = new _binSorter2.default(this.state.layerData || [], this.props.getColorValue);
      this.setState({ sortedBins: sortedBins });
    }
  }, {
    key: 'getValueDomain',
    value: function getValueDomain() {
      var _props2 = this.props,
          lowerPercentile = _props2.lowerPercentile,
          upperPercentile = _props2.upperPercentile;


      this.state.valueDomain = this.state.sortedBins.getValueRange([lowerPercentile, upperPercentile]);
    }
  }, {
    key: 'getPickingInfo',
    value: function getPickingInfo(_ref2) {
      var info = _ref2.info;

      var pickedCell = info.picked && info.index > -1 ? this.state.layerData[info.index] : null;

      return Object.assign(info, {
        picked: Boolean(pickedCell),
        // override object with picked cell
        object: pickedCell
      });
    }
  }, {
    key: 'getUpdateTriggers',
    value: function getUpdateTriggers() {
      return {
        getColor: {
          colorRange: this.props.colorRange,
          colorDomain: this.props.colorDomain,
          getColorValue: this.props.getColorValue,
          lowerPercentile: this.props.lowerPercentile,
          upperPercentile: this.props.upperPercentile
        },
        getElevation: {
          elevationRange: this.props.elevationRange,
          elevationDomain: this.props.elevationDomain
        }
      };
    }
  }, {
    key: '_onGetSublayerColor',
    value: function _onGetSublayerColor(cell) {
      var colorRange = this.props.colorRange;
      var _state = this.state,
          valueDomain = _state.valueDomain,
          sortedBins = _state.sortedBins;

      var value = sortedBins.binMap[cell.index] && sortedBins.binMap[cell.index].value;

      var colorDomain = this.props.colorDomain || valueDomain;
      var color = (0, _scaleUtils.quantizeScale)(colorDomain, colorRange, value);

      // if cell value is outside domain, set alpha to 0
      var alpha = value >= valueDomain[0] && value <= valueDomain[1] ? Number.isFinite(color[3]) ? color[3] : 255 : 0;

      // add final alpha to color
      color[3] = alpha;

      return color;
    }
  }, {
    key: '_onGetSublayerElevation',
    value: function _onGetSublayerElevation(cell) {
      var _props3 = this.props,
          elevationDomain = _props3.elevationDomain,
          elevationRange = _props3.elevationRange;
      var sortedBins = this.state.sortedBins;

      // elevation is based on counts, it is not affected by percentile

      var domain = elevationDomain || [0, sortedBins.maxCount];
      return (0, _scaleUtils.linearScale)(domain, elevationRange, cell.points.length);
    }
  }, {
    key: 'renderLayers',
    value: function renderLayers() {
      var _props4 = this.props,
          id = _props4.id,
          elevationScale = _props4.elevationScale,
          fp64 = _props4.fp64,
          extruded = _props4.extruded,
          cellSize = _props4.cellSize,
          coverage = _props4.coverage,
          lightSettings = _props4.lightSettings;

      // base layer props

      var _props5 = this.props,
          opacity = _props5.opacity,
          pickable = _props5.pickable,
          visible = _props5.visible,
          getPolygonOffset = _props5.getPolygonOffset;

      // viewport props

      var _props6 = this.props,
          positionOrigin = _props6.positionOrigin,
          projectionMode = _props6.projectionMode,
          modelMatrix = _props6.modelMatrix;


      return new _gridCellLayer2.default({
        id: id + '-grid-cell',
        data: this.state.layerData,
        cellSize: cellSize,
        coverage: coverage,
        lightSettings: lightSettings,
        elevationScale: elevationScale,
        extruded: extruded,
        fp64: fp64,
        opacity: opacity,
        pickable: pickable,
        visible: visible,
        getPolygonOffset: getPolygonOffset,
        projectionMode: projectionMode,
        positionOrigin: positionOrigin,
        modelMatrix: modelMatrix,
        getColor: this._onGetSublayerColor.bind(this),
        getElevation: this._onGetSublayerElevation.bind(this),
        getPosition: function getPosition(d) {
          return d.position;
        },
        updateTriggers: this.getUpdateTriggers()
      });
    }
  }]);

  return GridLayer;
}(_lib.CompositeLayer);

exports.default = GridLayer;


GridLayer.layerName = 'GridLayer';
GridLayer.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9sYXllcnMvY29yZS9ncmlkLWxheWVyL2dyaWQtbGF5ZXIuanMiXSwibmFtZXMiOlsiZGVmYXVsdFByb3BzIiwiY2VsbFNpemUiLCJjb2xvclJhbmdlIiwiY29sb3JEb21haW4iLCJlbGV2YXRpb25SYW5nZSIsImVsZXZhdGlvbkRvbWFpbiIsImVsZXZhdGlvblNjYWxlIiwibG93ZXJQZXJjZW50aWxlIiwidXBwZXJQZXJjZW50aWxlIiwiY292ZXJhZ2UiLCJnZXRQb3NpdGlvbiIsIngiLCJwb3NpdGlvbiIsImdldENvbG9yVmFsdWUiLCJwb2ludHMiLCJsZW5ndGgiLCJleHRydWRlZCIsImZwNjQiLCJsaWdodFNldHRpbmdzIiwibGlnaHRzUG9zaXRpb24iLCJhbWJpZW50UmF0aW8iLCJkaWZmdXNlUmF0aW8iLCJzcGVjdWxhclJhdGlvIiwibGlnaHRzU3RyZW5ndGgiLCJudW1iZXJPZkxpZ2h0cyIsIl9uZWVkc1JlUHJvamVjdFBvaW50cyIsIm9sZFByb3BzIiwicHJvcHMiLCJfcGVyY2VudGlsZUNoYW5nZWQiLCJfbmVlZHNSZVNvcnRCaW5zIiwiR3JpZExheWVyIiwic3RhdGUiLCJsYXllckRhdGEiLCJzb3J0ZWRCaW5zIiwidmFsdWVEb21haW4iLCJjaGFuZ2VGbGFncyIsImRhdGFDaGFuZ2VkIiwiZ2V0TGF5ZXJEYXRhIiwiZ2V0U29ydGVkQmlucyIsImdldFZhbHVlRG9tYWluIiwiZGF0YSIsInNldFN0YXRlIiwiZ2V0VmFsdWVSYW5nZSIsImluZm8iLCJwaWNrZWRDZWxsIiwicGlja2VkIiwiaW5kZXgiLCJPYmplY3QiLCJhc3NpZ24iLCJCb29sZWFuIiwib2JqZWN0IiwiZ2V0Q29sb3IiLCJnZXRFbGV2YXRpb24iLCJjZWxsIiwidmFsdWUiLCJiaW5NYXAiLCJjb2xvciIsImFscGhhIiwiTnVtYmVyIiwiaXNGaW5pdGUiLCJkb21haW4iLCJtYXhDb3VudCIsImlkIiwib3BhY2l0eSIsInBpY2thYmxlIiwidmlzaWJsZSIsImdldFBvbHlnb25PZmZzZXQiLCJwb3NpdGlvbk9yaWdpbiIsInByb2plY3Rpb25Nb2RlIiwibW9kZWxNYXRyaXgiLCJfb25HZXRTdWJsYXllckNvbG9yIiwiYmluZCIsIl9vbkdldFN1YmxheWVyRWxldmF0aW9uIiwiZCIsInVwZGF0ZVRyaWdnZXJzIiwiZ2V0VXBkYXRlVHJpZ2dlcnMiLCJsYXllck5hbWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBb0JBOztBQUNBOzs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7Ozs7Ozs7K2VBM0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQVdBLElBQU1BLGVBQWU7QUFDbkJDLFlBQVUsSUFEUztBQUVuQkMsMkNBRm1CO0FBR25CQyxlQUFhLElBSE07QUFJbkJDLGtCQUFnQixDQUFDLENBQUQsRUFBSSxJQUFKLENBSkc7QUFLbkJDLG1CQUFpQixJQUxFO0FBTW5CQyxrQkFBZ0IsQ0FORztBQU9uQkMsbUJBQWlCLENBUEU7QUFRbkJDLG1CQUFpQixHQVJFO0FBU25CQyxZQUFVLENBVFM7QUFVbkJDLGVBQWE7QUFBQSxXQUFLQyxFQUFFQyxRQUFQO0FBQUEsR0FWTTtBQVduQkMsaUJBQWU7QUFBQSxXQUFVQyxPQUFPQyxNQUFqQjtBQUFBLEdBWEk7QUFZbkJDLFlBQVUsS0FaUztBQWFuQkMsUUFBTSxLQWJhO0FBY25CO0FBQ0FDLGlCQUFlO0FBQ2JDLG9CQUFnQixDQUFDLENBQUMsTUFBRixFQUFVLEtBQVYsRUFBaUIsSUFBakIsRUFBdUIsQ0FBQyxLQUF4QixFQUErQixLQUEvQixFQUFzQyxJQUF0QyxDQURIO0FBRWJDLGtCQUFjLElBRkQ7QUFHYkMsa0JBQWMsR0FIRDtBQUliQyxtQkFBZSxHQUpGO0FBS2JDLG9CQUFnQixDQUFDLEdBQUQsRUFBTSxHQUFOLEVBQVcsR0FBWCxFQUFnQixHQUFoQixDQUxIO0FBTWJDLG9CQUFn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VSwwQkFQdUI7QUFRdkJDLGtCQVJ1QjtBQVN2QjhDLHdCQVR1QjtBQVV2QkMsMEJBVnVCO0FBV3ZCQyx3QkFYdUI7QUFZdkJDLDBDQVp1QjtBQWF2QkUsc0NBYnVCO0FBY3ZCRCxzQ0FkdUI7QUFldkJFLGdDQWZ1QjtBQWdCdkJsQixrQkFBVSxLQUFLbUIsbUJBQUwsQ0FBeUJDLElBQXpCLENBQThCLElBQTlCLENBaEJhO0FBaUJ2Qm5CLHNCQUFjLEtBQUtvQix1QkFBTCxDQUE2QkQsSUFBN0IsQ0FBa0MsSUFBbEMsQ0FqQlM7QUFrQnZCN0QscUJBQWE7QUFBQSxpQkFBSytELEVBQUU3RCxRQUFQO0FBQUEsU0FsQlU7QUFtQnZCOEQsd0JBQWdCLEtBQUtDLGlCQUFMO0FBbkJPLE9BQWxCLENBQVA7QUFxQkQ7Ozs7OztrQkFuSWtCN0MsUzs7O0FBc0lyQkEsVUFBVThDLFNBQVYsR0FBc0IsV0FBdEI7QUFDQTlDLFVBQVU5QixZQUFWLEdBQXlCQSxZQUF6QiIsImZpbGUiOiJncmlkLWxheWVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE1IC0gMjAxNyBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7Q29tcG9zaXRlTGF5ZXJ9IGZyb20gJy4uLy4uLy4uL2xpYic7XG5pbXBvcnQgR3JpZENlbGxMYXllciBmcm9tICcuLi9ncmlkLWNlbGwtbGF5ZXIvZ3JpZC1jZWxsLWxheWVyJztcblxuaW1wb3J0IHtwb2ludFRvRGVuc2l0eUdyaWREYXRhfSBmcm9tICcuL2dyaWQtYWdncmVnYXRvcic7XG5pbXBvcnQge2xpbmVhclNjYWxlLCBxdWFudGl6ZVNjYWxlfSBmcm9tICcuLi8uLi8uLi91dGlscy9zY2FsZS11dGlscyc7XG5pbXBvcnQge2RlZmF1bHRDb2xvclJhbmdlfSBmcm9tICcuLi8uLi8uLi91dGlscy9jb2xvci11dGlscyc7XG5cbmltcG9ydCBCaW5Tb3J0ZXIgZnJvbSAnLi4vLi4vLi4vdXRpbHMvYmluLXNvcnRlcic7XG5cbmNvbnN0IGRlZmF1bHRQcm9wcyA9IHtcbiAgY2VsbFNpemU6IDEwMDAsXG4gIGNvbG9yUmFuZ2U6IGRlZmF1bHRDb2xvclJhbmdlLFxuICBjb2xvckRvbWFpbjogbnVsbCxcbiAgZWxldmF0aW9uUmFuZ2U6IFswLCAxMDAwXSxcbiAgZWxldmF0aW9uRG9tYWluOiBudWxsLFxuICBlbGV2YXRpb25TY2FsZTogMSxcbiAgbG93ZXJQZXJjZW50aWxlOiAwLFxuICB1cHBlclBlcmNlbnRpbGU6IDEwMCxcbiAgY292ZXJhZ2U6IDEsXG4gIGdldFBvc2l0aW9uOiB4ID0+IHgucG9zaXRpb24sXG4gIGdldENvbG9yVmFsdWU6IHBvaW50cyA9PiBwb2ludHMubGVuZ3RoLFxuICBleHRydWRlZDogZmFsc2UsXG4gIGZwNjQ6IGZhbHNlLFxuICAvLyBPcHRpb25hbCBzZXR0aW5ncyBmb3IgJ2xpZ2h0aW5nJyBzaGFkZXIgbW9kdWxlXG4gIGxpZ2h0U2V0dGluZ3M6IHtcbiAgICBsaWdodHNQb3NpdGlvbjogWy0xMjIuNDUsIDM3Ljc1LCA4MDAwLCAtMTIyLjAsIDM4LjAwLCA1MDAwXSxcbiAgICBhbWJpZW50UmF0aW86IDAuMDUsXG4gICAgZGlmZnVzZVJhdGlvOiAwLjYsXG4gICAgc3BlY3VsYXJSYXRpbzogMC44LFxuICAgIGxpZ2h0c1N0cmVuZ3RoOiBbMi4wLCAwLjAsIDAuMCwgMC4wXSxcbiAgICBudW1iZXJPZkxpZ2h0czogMlxuICB9XG59O1xuXG5mdW5jdGlvbiBfbmVlZHNSZVByb2plY3RQb2ludHMob2xkUHJvcHMsIHByb3BzKSB7XG4gIHJldHVybiBvbGRQcm9wcy5jZWxsU2l6ZSAhPT0gcHJvcHMuY2VsbFNpemU7XG59XG5cbmZ1bmN0aW9uIF9wZXJjZW50aWxlQ2hhbmdlZChvbGRQcm9wcywgcHJvcHMpIHtcbiAgcmV0dXJuIG9sZFByb3BzLmxvd2VyUGVyY2VudGlsZSAhPT0gcHJvcHMubG93ZXJQZXJjZW50aWxlIHx8XG4gICAgb2xkUHJvcHMudXBwZXJQZXJjZW50aWxlICE9PSBwcm9wcy51cHBlclBlcmNlbnRpbGU7XG59XG5cbmZ1bmN0aW9uIF9uZWVkc1JlU29ydEJpbnMob2xkUHJvcHMsIHByb3BzKSB7XG4gIHJldHVybiBvbGRQcm9wcy5nZXRDb2xvclZhbHVlICE9PSBwcm9wcy5nZXRDb2xvclZhbHVlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHcmlkTGF5ZXIgZXh0ZW5kcyBDb21wb3NpdGVMYXllciB7XG4gIGluaXRpYWxpemVTdGF0ZSgpIHtcbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgbGF5ZXJEYXRhOiBbXSxcbiAgICAgIHNvcnRlZEJpbnM6IG51bGwsXG4gICAgICB2YWx1ZURvbWFpbjogbnVsbFxuICAgIH07XG4gIH1cblxuICB1cGRhdGVTdGF0ZSh7b2xkUHJvcHMsIHByb3BzLCBjaGFuZ2VGbGFnc30pIHtcbiAgICBpZiAoY2hhbmdlRmxhZ3MuZGF0YUNoYW5nZWQgfHwgX25lZWRzUmVQcm9qZWN0UG9pbnRzKG9sZFByb3BzLCBwcm9wcykpIHtcbiAgICAgIC8vIHByb2plY3QgZGF0YSBpbnRvIGhleGFnb25zLCBhbmQgZ2V0IHNvcnRlZEJpbnNcbiAgICAgIHRoaXMuZ2V0TGF5ZXJEYXRhKCk7XG4gICAgICB0aGlzLmdldFNvcnRlZEJpbnMoKTtcblxuICAgICAgLy8gdGhpcyBuZWVkcyBzb3J0ZWRCaW5zIHRvIGJlIHNldFxuICAgICAgdGhpcy5nZXRWYWx1ZURvbWFpbigpO1xuICAgIH0gZWxzZSBpZiAoX25lZWRzUmVTb3J0QmlucyhvbGRQcm9wcywgcHJvcHMpKSB7XG5cbiAgICAgIHRoaXMuZ2V0U29ydGVkQmlucygpO1xuICAgICAgdGhpcy5nZXRWYWx1ZURvbWFpbigpO1xuXG4gICAgfSBlbHNlIGlmIChfcGVyY2VudGlsZUNoYW5nZWQob2xkUHJvcHMsIHByb3BzKSkge1xuXG4gICAgICB0aGlzLmdldFZhbHVlRG9tYWluKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TGF5ZXJEYXRhKCkge1xuICAgIGNvbnN0IHtkYXRhLCBjZWxsU2l6ZSwgZ2V0UG9zaXRpb259ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7bGF5ZXJEYXRhfSA9IHBvaW50VG9EZW5zaXR5R3JpZERhdGEoZGF0YSwgY2VsbFNpemUsIGdldFBvc2l0aW9uKTtcblxuICAgIHRoaXMuc2V0U3RhdGUoe2xheWVyRGF0YX0pO1xuICB9XG5cbiAgZ2V0U29ydGVkQmlucygpIHtcbiAgICBjb25zdCBzb3J0ZWRCaW5zID0gbmV3IEJpblNvcnRlcih0aGlzLnN0YXRlLmxheWVyRGF0YSB8fCBbXSwgdGhpcy5wcm9wcy5nZXRDb2xvclZhbHVlKTtcbiAgICB0aGlzLnNldFN0YXRlKHtzb3J0ZWRCaW5zfSk7XG4gIH1cblxuICBnZXRWYWx1ZURvbWFpbigpIHtcbiAgICBjb25zdCB7bG93ZXJQZXJjZW50aWxlLCB1cHBlclBlcmNlbnRpbGV9ID0gdGhpcy5wcm9wcztcblxuICAgIHRoaXMuc3RhdGUudmFsdWVEb21haW4gPSB0aGlzLnN0YXRlLnNvcnRlZEJpbnNcbiAgICAgIC5nZXRWYWx1ZVJhbmdlKFtsb3dlclBlcmNlbnRpbGUsIHVwcGVyUGVyY2VudGlsZV0pO1xuICB9XG5cbiAgZ2V0UGlja2luZ0luZm8oe2luZm99KSB7XG4gICAgY29uc3QgcGlja2VkQ2VsbCA9IGluZm8ucGlja2VkICYmIGluZm8uaW5kZXggPiAtMSA/XG4gICAgICB0aGlzLnN0YXRlLmxheWVyRGF0YVtpbmZvLmluZGV4XSA6IG51bGw7XG5cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihpbmZvLCB7XG4gICAgICBwaWNrZWQ6IEJvb2xlYW4ocGlja2VkQ2VsbCksXG4gICAgICAvLyBvdmVycmlkZSBvYmplY3Qgd2l0aCBwaWNrZWQgY2VsbFxuICAgICAgb2JqZWN0OiBwaWNrZWRDZWxsXG4gICAgfSk7XG4gIH1cblxuICBnZXRVcGRhdGVUcmlnZ2VycygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ2V0Q29sb3I6IHtcbiAgICAgICAgY29sb3JSYW5nZTogdGhpcy5wcm9wcy5jb2xvclJhbmdlLFxuICAgICAgICBjb2xvckRvbWFpbjogdGhpcy5wcm9wcy5jb2xvckRvbWFpbixcbiAgICAgICAgZ2V0Q29sb3JWYWx1ZTogdGhpcy5wcm9wcy5nZXRDb2xvclZhbHVlLFxuICAgICAgICBsb3dlclBlcmNlbnRpbGU6IHRoaXMucHJvcHMubG93ZXJQZXJjZW50aWxlLFxuICAgICAgICB1cHBlclBlcmNlbnRpbGU6IHRoaXMucHJvcHMudXBwZXJQZXJjZW50aWxlXG4gICAgICB9LFxuICAgICAgZ2V0RWxldmF0aW9uOiB7XG4gICAgICAgIGVsZXZhdGlvblJhbmdlOiB0aGlzLnByb3BzLmVsZXZhdGlvblJhbmdlLFxuICAgICAgICBlbGV2YXRpb25Eb21haW46IHRoaXMucHJvcHMuZWxldmF0aW9uRG9tYWluXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIF9vbkdldFN1YmxheWVyQ29sb3IoY2VsbCkge1xuICAgIGNvbnN0IHtjb2xvclJhbmdlfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3Qge3ZhbHVlRG9tYWluLCBzb3J0ZWRCaW5zfSA9IHRoaXMuc3RhdGU7XG4gICAgY29uc3QgdmFsdWUgPSBzb3J0ZWRCaW5zLmJpbk1hcFtjZWxsLmluZGV4XSAmJiBzb3J0ZWRCaW5zLmJpbk1hcFtjZWxsLmluZGV4XS52YWx1ZTtcblxuICAgIGNvbnN0IGNvbG9yRG9tYWluID0gdGhpcy5wcm9wcy5jb2xvckRvbWFpbiB8fCB2YWx1ZURvbWFpbjtcbiAgICBjb25zdCBjb2xvciA9IHF1YW50aXplU2NhbGUoY29sb3JEb21haW4sIGNvbG9yUmFuZ2UsIHZhbHVlKTtcblxuICAgIC8vIGlmIGNlbGwgdmFsdWUgaXMgb3V0c2lkZSBkb21haW4sIHNldCBhbHBoYSB0byAwXG4gICAgY29uc3QgYWxwaGEgPSB2YWx1ZSA+PSB2YWx1ZURvbWFpblswXSAmJiB2YWx1ZSA8PSB2YWx1ZURvbWFpblsxXSA/XG4gICAgICAoTnVtYmVyLmlzRmluaXRlKGNvbG9yWzNdKSA/IGNvbG9yWzNdIDogMjU1KSA6IDA7XG5cbiAgICAvLyBhZGQgZmluYWwgYWxwaGEgdG8gY29sb3JcbiAgICBjb2xvclszXSA9IGFscGhhO1xuXG4gICAgcmV0dXJuIGNvbG9yO1xuICB9XG5cbiAgX29uR2V0U3VibGF5ZXJFbGV2YXRpb24oY2VsbCkge1xuICAgIGNvbnN0IHtlbGV2YXRpb25Eb21haW4sIGVsZXZhdGlvblJhbmdlfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3Qge3NvcnRlZEJpbnN9ID0gdGhpcy5zdGF0ZTtcblxuICAgIC8vIGVsZXZhdGlvbiBpcyBiYXNlZCBvbiBjb3VudHMsIGl0IGlzIG5vdCBhZmZlY3RlZCBieSBwZXJjZW50aWxlXG4gICAgY29uc3QgZG9tYWluID0gZWxldmF0aW9uRG9tYWluIHx8IFswLCBzb3J0ZWRCaW5zLm1heENvdW50XTtcbiAgICByZXR1cm4gbGluZWFyU2NhbGUoZG9tYWluLCBlbGV2YXRpb25SYW5nZSwgY2VsbC5wb2ludHMubGVuZ3RoKTtcbiAgfVxuXG4gIHJlbmRlckxheWVycygpIHtcbiAgICBjb25zdCB7aWQsIGVsZXZhdGlvblNjYWxlLCBmcDY0LCBleHRydWRlZCwgY2VsbFNpemUsIGNvdmVyYWdlLCBsaWdodFNldHRpbmdzfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBiYXNlIGxheWVyIHByb3BzXG4gICAgY29uc3Qge29wYWNpdHksIHBpY2thYmxlLCB2aXNpYmxlLCBnZXRQb2x5Z29uT2Zmc2V0fSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyB2aWV3cG9ydCBwcm9wc1xuICAgIGNvbnN0IHtwb3NpdGlvbk9yaWdpbiwgcHJvamVjdGlvbk1vZGUsIG1vZGVsTWF0cml4fSA9IHRoaXMucHJvcHM7XG5cbiAgICByZXR1cm4gbmV3IEdyaWRDZWxsTGF5ZXIoe1xuICAgICAgaWQ6IGAke2lkfS1ncmlkLWNlbGxgLFxuICAgICAgZGF0YTogdGhpcy5zdGF0ZS5sYXllckRhdGEsXG4gICAgICBjZWxsU2l6ZSxcbiAgICAgIGNvdmVyYWdlLFxuICAgICAgbGlnaHRTZXR0aW5ncyxcbiAgICAgIGVsZXZhdGlvblNjYWxlLFxuICAgICAgZXh0cnVkZWQsXG4gICAgICBmcDY0LFxuICAgICAgb3BhY2l0eSxcbiAgICAgIHBpY2thYmxlLFxuICAgICAgdmlzaWJsZSxcbiAgICAgIGdldFBvbHlnb25PZmZzZXQsXG4gICAgICBwcm9qZWN0aW9uTW9kZSxcbiAgICAgIHBvc2l0aW9uT3JpZ2luLFxuICAgICAgbW9kZWxNYXRyaXgsXG4gICAgICBnZXRDb2xvcjogdGhpcy5fb25HZXRTdWJsYXllckNvbG9yLmJpbmQodGhpcyksXG4gICAgICBnZXRFbGV2YXRpb246IHRoaXMuX29uR2V0U3VibGF5ZXJFbGV2YXRpb24uYmluZCh0aGlzKSxcbiAgICAgIGdldFBvc2l0aW9uOiBkID0+IGQucG9zaXRpb24sXG4gICAgICB1cGRhdGVUcmlnZ2VyczogdGhpcy5nZXRVcGRhdGVUcmlnZ2VycygpXG4gICAgfSk7XG4gIH1cbn1cblxuR3JpZExheWVyLmxheWVyTmFtZSA9ICdHcmlkTGF5ZXInO1xuR3JpZExheWVyLmRlZmF1bHRQcm9wcyA9IGRlZmF1bHRQcm9wcztcbiJdfQ==