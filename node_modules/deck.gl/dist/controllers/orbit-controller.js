'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _react = require('react');

var _deck = require('deck.gl');

var _glMatrix = require('gl-matrix');

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } /* global window */


/* Utils */

// constrain number between bounds
function clamp(x, min, max) {
  if (x < min) {
    return min;
  }
  if (x > max) {
    return max;
  }
  return x;
}

var ua = typeof window.navigator !== 'undefined' ? window.navigator.userAgent.toLowerCase() : '';
var firefox = ua.indexOf('firefox') !== -1;

var propTypes = {
  // target position
  lookAt: _react.PropTypes.arrayOf(_react.PropTypes.number),
  // camera distance
  distance: _react.PropTypes.number.isRequired,
  minDistance: _react.PropTypes.number,
  maxDistance: _react.PropTypes.number,
  // rotation
  rotationX: _react.PropTypes.number,
  rotationY: _react.PropTypes.number,
  // field of view
  fov: _react.PropTypes.number,
  // viewport width in pixels
  width: _react.PropTypes.number.isRequired,
  // viewport height in pixels
  height: _react.PropTypes.number.isRequired,
  // callback
  onViewportChange: _react.PropTypes.func.isRequired
};

var defaultProps = {
  lookAt: [0, 0, 0],
  rotationX: 0,
  rotationY: 0,
  minDistance: 0,
  maxDistance: Infinity,
  fov: 50
};

var OrbitController = function (_Component) {
  _inherits(OrbitController, _Component);

  _createClass(OrbitController, null, [{
    key: 'getViewport',
    value: function getViewport(_ref) {
      var width = _ref.width,
          height = _ref.height,
          lookAt = _ref.lookAt,
          distance = _ref.distance,
          rotationX = _ref.rotationX,
          rotationY = _ref.rotationY,
          fov = _ref.fov;

      var cameraPos = _glMatrix.vec3.add([], lookAt, [0, 0, distance]);
      _glMatrix.vec3.rotateX(cameraPos, cameraPos, lookAt, rotationX / 180 * Math.PI);
      _glMatrix.vec3.rotateY(cameraPos, cameraPos, lookAt, rotationY / 180 * Math.PI);

      return new _deck.PerspectiveViewport({
        width: width,
        height: height,
        lookAt: lookAt,
        far: 1000,
        near: 0.1,
        fovy: fov,
        eye: cameraPos
      });
    }
  }]);

  function OrbitController(props) {
    _classCallCheck(this, OrbitController);

    var _this = _possibleConstructorReturn(this, (OrbitController.__proto__ || Object.getPrototypeOf(OrbitController)).call(this, props));

    _this._dragStartPos = null;
    return _this;
  }

  _createClass(OrbitController, [{
    key: '_onDragStart',
    value: function _onDragStart(evt) {
      var pageX = evt.pageX,
          pageY = evt.pageY;

      this._dragStartPos = [pageX, pageY];
      this.props.onViewportChange({ isDragging: true });
    }
  }, {
    key: '_onDrag',
    value: function _onDrag(evt) {
      if (this._dragStartPos) {
        var pageX = evt.pageX,
            pageY = evt.pageY;
        var _props = this.props,
            width = _props.width,
            height = _props.height;

        var dx = (pageX - this._dragStartPos[0]) / width;
        var dy = (pageY - this._dragStartPos[1]) / height;

        if (evt.shiftKey || evt.ctrlKey || evt.altKey || evt.metaKey) {
          // pan
          var _props2 = this.props,
              lookAt = _props2.lookAt,
              distance = _props2.distance,
              rotationX = _props2.rotationX,
              rotationY = _props2.rotationY,
              fov = _props2.fov;


          var unitsPerPixel = distance / Math.tan(fov / 180 * Math.PI / 2) / 2;

          var newLookAt = _glMatrix.vec3.add([], lookAt, [-unitsPerPixel * dx, unitsPerPixel * dy, 0]);
          _glMatrix.vec3.rotateX(newLookAt, newLookAt, lookAt, rotationX / 180 * Math.PI);
          _glMatrix.vec3.rotateY(newLookAt, newLookAt, lookAt, rotationY / 180 * Math.PI);

          this.props.onViewportChange({
            lookAt: newLookAt
          });
        } else {
          // rotate
          var _props3 = this.props,
              _rotationX = _props3.rotationX,
              _rotationY = _props3.rotationY;

          var newRotationX = clamp(_rotationX - dy * 180, -90, 90);
          var newRotationY = (_rotationY - dx * 180) % 360;

          this.props.onViewportChange({
            rotationX: newRotationX,
            rotationY: newRotationY
          });
        }

        this._dragStartPos = [pageX, pageY];
      }
    }
  }, {
    key: '_onDragEnd',
    value: function _onDragEnd() {
      this._dragStartPos = null;
      this.props.onViewportChange({ isDragging: false });
    }
  }, {
    key: '_onWheel',
    value: function _onWheel(evt) {
      evt.preventDefault();
      var value = evt.deltaY;
      // Firefox doubles the values on retina screens...
      if (firefox && evt.deltaMode === window.WheelEvent.DOM_DELTA_PIXEL) {
        value /= window.devicePixelRatio;
      }
      if (evt.deltaMode === window.WheelEvent.DOM_DELTA_LINE) {
        value *= 40;
      }
      if (value !== 0 && value % 4.000244140625 === 0) {
        // This one is definitely a mouse wheel event.
        // Normalize this value to match trackpad.
        value = Math.floor(value / 4);
      }

      var _props4 = this.props,
          distance = _props4.distance,
          minDistance = _props4.minDistance,
          maxDistance = _props4.maxDistance;

      var newDistance = clamp(distance * Math.pow(1.01, value), minDistance, maxDistance);

      this.props.onViewportChange({
        distance: newDistance
      });
    }

    // public API

  }, {
    key: 'fitBounds',
    value: function fitBounds(min, max) {
      var fov = this.props.fov;

      var size = Math.max(max[0] - min[0], max[1] - min[1], max[2] - min[2]);
      var newDistance = size / Math.tan(fov / 180 * Math.PI / 2) / 2;

      this.props.onViewportChange({
        distance: newDistance
      });
    }
  }, {
    key: 'render',
    value: function render() {
      return (0, _react.createElement)('div', {
        style: { position: 'relative', userSelect: 'none' },
        onMouseDown: this._onDragStart.bind(this),
        onMouseMove: this._onDrag.bind(this),
        onMouseLeave: this._onDragEnd.bind(this),
        onMouseUp: this._onDragEnd.bind(this),
        onWheel: this._onWheel.bind(this),
        children: this.props.children
      });
    }
  }]);

  return OrbitController;
}(_react.Component);

exports.default = OrbitController;


OrbitController.propTypes = propTypes;
OrbitController.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9vcmJpdC1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbImNsYW1wIiwieCIsIm1pbiIsIm1heCIsInVhIiwid2luZG93IiwibmF2aWdhdG9yIiwidXNlckFnZW50IiwidG9Mb3dlckNhc2UiLCJmaXJlZm94IiwiaW5kZXhPZiIsInByb3BUeXBlcyIsImxvb2tBdCIsImFycmF5T2YiLCJudW1iZXIiLCJkaXN0YW5jZSIsImlzUmVxdWlyZWQiLCJtaW5EaXN0YW5jZSIsIm1heERpc3RhbmNlIiwicm90YXRpb25YIiwicm90YXRpb25ZIiwiZm92Iiwid2lkdGgiLCJoZWlnaHQiLCJvblZpZXdwb3J0Q2hhbmdlIiwiZnVuYyIsImRlZmF1bHRQcm9wcyIsIkluZmluaXR5IiwiT3JiaXRDb250cm9sbGVyIiwiY2FtZXJhUG9zIiwiYWRkIiwicm90YXRlWCIsIk1hdGgiLCJQSSIsInJvdGF0ZVkiLCJmYXIiLCJuZWFyIiwiZm92eSIsImV5ZSIsInByb3BzIiwiX2RyYWdTdGFydFBvcyIsImV2dCIsInBhZ2VYIiwicGFnZVkiLCJpc0RyYWdnaW5nIiwiZHgiLCJkeSIsInNoaWZ0S2V5IiwiY3RybEtleSIsImFsdEtleSIsIm1ldGFLZXkiLCJ1bml0c1BlclBpeGVsIiwidGFuIiwibmV3TG9va0F0IiwibmV3Um90YXRpb25YIiwibmV3Um90YXRpb25ZIiwicHJldmVudERlZmF1bHQiLCJ2YWx1ZSIsImRlbHRhWSIsImRlbHRhTW9kZSIsIldoZWVsRXZlbnQiLCJET01fREVMVEFfUElYRUwiLCJkZXZpY2VQaXhlbFJhdGlvIiwiRE9NX0RFTFRBX0xJTkUiLCJmbG9vciIsIm5ld0Rpc3RhbmNlIiwicG93Iiwic2l6ZSIsInN0eWxlIiwicG9zaXRpb24iLCJ1c2VyU2VsZWN0Iiwib25Nb3VzZURvd24iLCJfb25EcmFnU3RhcnQiLCJiaW5kIiwib25Nb3VzZU1vdmUiLCJfb25EcmFnIiwib25Nb3VzZUxlYXZlIiwiX29uRHJhZ0VuZCIs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Q0FBL0IsQ0FBUCxHQUEyQyxDQUEvRDs7QUFFQSxXQUFLTSxLQUFMLENBQVdmLGdCQUFYLENBQTRCO0FBQzFCVCxrQkFBVWtEO0FBRGdCLE9BQTVCO0FBR0Q7Ozs2QkFFUTtBQUNQLGFBQU8sMEJBQWMsS0FBZCxFQUFxQjtBQUMxQkcsZUFBTyxFQUFDQyxVQUFVLFVBQVgsRUFBdUJDLFlBQVksTUFBbkMsRUFEbUI7QUFFMUJDLHFCQUFhLEtBQUtDLFlBQUwsQ0FBa0JDLElBQWxCLENBQXVCLElBQXZCLENBRmE7QUFHMUJDLHFCQUFhLEtBQUtDLE9BQUwsQ0FBYUYsSUFBYixDQUFrQixJQUFsQixDQUhhO0FBSTFCRyxzQkFBYyxLQUFLQyxVQUFMLENBQWdCSixJQUFoQixDQUFxQixJQUFyQixDQUpZO0FBSzFCSyxtQkFBVyxLQUFLRCxVQUFMLENBQWdCSixJQUFoQixDQUFxQixJQUFyQixDQUxlO0FBTTFCTSxpQkFBUyxLQUFLQyxRQUFMLENBQWNQLElBQWQsQ0FBbUIsSUFBbkIsQ0FOaUI7QUFPMUJRLGtCQUFVLEtBQUsxQyxLQUFMLENBQVcwQztBQVBLLE9BQXJCLENBQVA7QUFTRDs7Ozs7O2tCQW5Ia0JyRCxlOzs7QUFzSHJCQSxnQkFBZ0JqQixTQUFoQixHQUE0QkEsU0FBNUI7QUFDQWlCLGdCQUFnQkYsWUFBaEIsR0FBK0JBLFlBQS9CIiwiZmlsZSI6Im9yYml0LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgd2luZG93ICovXG5pbXBvcnQge0NvbXBvbmVudCwgUHJvcFR5cGVzLCBjcmVhdGVFbGVtZW50fSBmcm9tICdyZWFjdCc7XG5pbXBvcnQge1BlcnNwZWN0aXZlVmlld3BvcnR9IGZyb20gJ2RlY2suZ2wnO1xuaW1wb3J0IHt2ZWMzfSBmcm9tICdnbC1tYXRyaXgnO1xuXG4vKiBVdGlscyAqL1xuXG4vLyBjb25zdHJhaW4gbnVtYmVyIGJldHdlZW4gYm91bmRzXG5mdW5jdGlvbiBjbGFtcCh4LCBtaW4sIG1heCkge1xuICBpZiAoeCA8IG1pbikge1xuICAgIHJldHVybiBtaW47XG4gIH1cbiAgaWYgKHggPiBtYXgpIHtcbiAgICByZXR1cm4gbWF4O1xuICB9XG4gIHJldHVybiB4O1xufVxuXG5jb25zdCB1YSA9IHR5cGVvZiB3aW5kb3cubmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyA/XG4gIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkgOiAnJztcbmNvbnN0IGZpcmVmb3ggPSB1YS5pbmRleE9mKCdmaXJlZm94JykgIT09IC0xO1xuXG5jb25zdCBwcm9wVHlwZXMgPSB7XG4gIC8vIHRhcmdldCBwb3NpdGlvblxuICBsb29rQXQ6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5udW1iZXIpLFxuICAvLyBjYW1lcmEgZGlzdGFuY2VcbiAgZGlzdGFuY2U6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcbiAgbWluRGlzdGFuY2U6IFByb3BUeXBlcy5udW1iZXIsXG4gIG1heERpc3RhbmNlOiBQcm9wVHlwZXMubnVtYmVyLFxuICAvLyByb3RhdGlvblxuICByb3RhdGlvblg6IFByb3BUeXBlcy5udW1iZXIsXG4gIHJvdGF0aW9uWTogUHJvcFR5cGVzLm51bWJlcixcbiAgLy8gZmllbGQgb2Ygdmlld1xuICBmb3Y6IFByb3BUeXBlcy5udW1iZXIsXG4gIC8vIHZpZXdwb3J0IHdpZHRoIGluIHBpeGVsc1xuICB3aWR0aDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuICAvLyB2aWV3cG9ydCBoZWlnaHQgaW4gcGl4ZWxzXG4gIGhlaWdodDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuICAvLyBjYWxsYmFja1xuICBvblZpZXdwb3J0Q2hhbmdlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkXG59O1xuXG5jb25zdCBkZWZhdWx0UHJvcHMgPSB7XG4gIGxvb2tBdDogWzAsIDAsIDBdLFxuICByb3RhdGlvblg6IDAsXG4gIHJvdGF0aW9uWTogMCxcbiAgbWluRGlzdGFuY2U6IDAsXG4gIG1heERpc3RhbmNlOiBJbmZpbml0eSxcbiAgZm92OiA1MFxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT3JiaXRDb250cm9sbGVyIGV4dGVuZHMgQ29tcG9uZW50IHtcblxuICBzdGF0aWMgZ2V0Vmlld3BvcnQoe3dpZHRoLCBoZWlnaHQsIGxvb2tBdCwgZGlzdGFuY2UsIHJvdGF0aW9uWCwgcm90YXRpb25ZLCBmb3Z9KSB7XG4gICAgY29uc3QgY2FtZXJhUG9zID0gdmVjMy5hZGQoW10sIGxvb2tBdCwgWzAsIDAsIGRpc3RhbmNlXSk7XG4gICAgdmVjMy5yb3RhdGVYKGNhbWVyYVBvcywgY2FtZXJhUG9zLCBsb29rQXQsIHJvdGF0aW9uWCAvIDE4MCAqIE1hdGguUEkpO1xuICAgIHZlYzMucm90YXRlWShjYW1lcmFQb3MsIGNhbWVyYVBvcywgbG9va0F0LCByb3RhdGlvblkgLyAxODAgKiBNYXRoLlBJKTtcblxuICAgIHJldHVybiBuZXcgUGVyc3BlY3RpdmVWaWV3cG9ydCh7XG4gICAgICB3aWR0aCxcbiAgICAgIGhlaWdodCxcbiAgICAgIGxvb2tBdCxcbiAgICAgIGZhcjogMTAwMCxcbiAgICAgIG5lYXI6IDAuMSxcbiAgICAgIGZvdnk6IGZvdixcbiAgICAgIGV5ZTogY2FtZXJhUG9zXG4gICAgfSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICB0aGlzLl9kcmFnU3RhcnRQb3MgPSBudWxsO1xuICB9XG5cbiAgX29uRHJhZ1N0YXJ0KGV2dCkge1xuICAgIGNvbnN0IHtwYWdlWCwgcGFnZVl9ID0gZXZ0O1xuICAgIHRoaXMuX2RyYWdTdGFydFBvcyA9IFtwYWdlWCwgcGFnZVldO1xuICAgIHRoaXMucHJvcHMub25WaWV3cG9ydENoYW5nZSh7aXNEcmFnZ2luZzogdHJ1ZX0pO1xuICB9XG5cbiAgX29uRHJhZyhldnQpIHtcbiAgICBpZiAodGhpcy5fZHJhZ1N0YXJ0UG9zKSB7XG4gICAgICBjb25zdCB7cGFnZVgsIHBhZ2VZfSA9IGV2dDtcbiAgICAgIGNvbnN0IHt3aWR0aCwgaGVpZ2h0fSA9IHRoaXMucHJvcHM7XG4gICAgICBjb25zdCBkeCA9IChwYWdlWCAtIHRoaXMuX2RyYWdTdGFydFBvc1swXSkgLyB3aWR0aDtcbiAgICAgIGNvbnN0IGR5ID0gKHBhZ2VZIC0gdGhpcy5fZHJhZ1N0YXJ0UG9zWzFdKSAvIGhlaWdodDtcblxuICAgICAgaWYgKGV2dC5zaGlmdEtleSB8fCBldnQuY3RybEtleSB8fCBldnQuYWx0S2V5IHx8IGV2dC5tZXRhS2V5KSB7XG4gICAgICAgIC8vIHBhblxuICAgICAgICBjb25zdCB7bG9va0F0LCBkaXN0YW5jZSwgcm90YXRpb25YLCByb3RhdGlvblksIGZvdn0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGNvbnN0IHVuaXRzUGVyUGl4ZWwgPSBkaXN0YW5jZSAvIE1hdGgudGFuKGZvdiAvIDE4MCAqIE1hdGguUEkgLyAyKSAvIDI7XG5cbiAgICAgICAgY29uc3QgbmV3TG9va0F0ID0gdmVjMy5hZGQoW10sIGxvb2tBdCwgWy11bml0c1BlclBpeGVsICogZHgsIHVuaXRzUGVyUGl4ZWwgKiBkeSwgMF0pO1xuICAgICAgICB2ZWMzLnJvdGF0ZVgobmV3TG9va0F0LCBuZXdMb29rQXQsIGxvb2tBdCwgcm90YXRpb25YIC8gMTgwICogTWF0aC5QSSk7XG4gICAgICAgIHZlYzMucm90YXRlWShuZXdMb29rQXQsIG5ld0xvb2tBdCwgbG9va0F0LCByb3RhdGlvblkgLyAxODAgKiBNYXRoLlBJKTtcblxuICAgICAgICB0aGlzLnByb3BzLm9uVmlld3BvcnRDaGFuZ2Uoe1xuICAgICAgICAgIGxvb2tBdDogbmV3TG9va0F0XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gcm90YXRlXG4gICAgICAgIGNvbnN0IHtyb3RhdGlvblgsIHJvdGF0aW9uWX0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCBuZXdSb3RhdGlvblggPSBjbGFtcChyb3RhdGlvblggLSBkeSAqIDE4MCwgLTkwLCA5MCk7XG4gICAgICAgIGNvbnN0IG5ld1JvdGF0aW9uWSA9IChyb3RhdGlvblkgLSBkeCAqIDE4MCkgJSAzNjA7XG5cbiAgICAgICAgdGhpcy5wcm9wcy5vblZpZXdwb3J0Q2hhbmdlKHtcbiAgICAgICAgICByb3RhdGlvblg6IG5ld1JvdGF0aW9uWCxcbiAgICAgICAgICByb3RhdGlvblk6IG5ld1JvdGF0aW9uWVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fZHJhZ1N0YXJ0UG9zID0gW3BhZ2VYLCBwYWdlWV07XG4gICAgfVxuICB9XG5cbiAgX29uRHJhZ0VuZCgpIHtcbiAgICB0aGlzLl9kcmFnU3RhcnRQb3MgPSBudWxsO1xuICAgIHRoaXMucHJvcHMub25WaWV3cG9ydENoYW5nZSh7aXNEcmFnZ2luZzogZmFsc2V9KTtcbiAgfVxuXG4gIF9vbldoZWVsKGV2dCkge1xuICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGxldCB2YWx1ZSA9IGV2dC5kZWx0YVk7XG4gICAgLy8gRmlyZWZveCBkb3VibGVzIHRoZSB2YWx1ZXMgb24gcmV0aW5hIHNjcmVlbnMuLi5cbiAgICBpZiAoZmlyZWZveCAmJiBldnQuZGVsdGFNb2RlID09PSB3aW5kb3cuV2hlZWxFdmVudC5ET01fREVMVEFfUElYRUwpIHtcbiAgICAgIHZhbHVlIC89IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgIH1cbiAgICBpZiAoZXZ0LmRlbHRhTW9kZSA9PT0gd2luZG93LldoZWVsRXZlbnQuRE9NX0RFTFRBX0xJTkUpIHtcbiAgICAgIHZhbHVlICo9IDQwO1xuICAgIH1cbiAgICBpZiAodmFsdWUgIT09IDAgJiYgdmFsdWUgJSA0LjAwMDI0NDE0MDYyNSA9PT0gMCkge1xuICAgICAgLy8gVGhpcyBvbmUgaXMgZGVmaW5pdGVseSBhIG1vdXNlIHdoZWVsIGV2ZW50LlxuICAgICAgLy8gTm9ybWFsaXplIHRoaXMgdmFsdWUgdG8gbWF0Y2ggdHJhY2twYWQuXG4gICAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUgLyA0KTtcbiAgICB9XG5cbiAgICBjb25zdCB7ZGlzdGFuY2UsIG1pbkRpc3RhbmNlLCBtYXhEaXN0YW5jZX0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IG5ld0Rpc3RhbmNlID0gY2xhbXAoZGlzdGFuY2UgKiBNYXRoLnBvdygxLjAxLCB2YWx1ZSksIG1pbkRpc3RhbmNlLCBtYXhEaXN0YW5jZSk7XG5cbiAgICB0aGlzLnByb3BzLm9uVmlld3BvcnRDaGFuZ2Uoe1xuICAgICAgZGlzdGFuY2U6IG5ld0Rpc3RhbmNlXG4gICAgfSk7XG4gIH1cblxuICAvLyBwdWJsaWMgQVBJXG4gIGZpdEJvdW5kcyhtaW4sIG1heCkge1xuICAgIGNvbnN0IHtmb3Z9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBzaXplID0gTWF0aC5tYXgobWF4WzBdIC0gbWluWzBdLCBtYXhbMV0gLSBtaW5bMV0sIG1heFsyXSAtIG1pblsyXSk7XG4gICAgY29uc3QgbmV3RGlzdGFuY2UgPSBzaXplIC8gTWF0aC50YW4oZm92IC8gMTgwICogTWF0aC5QSSAvIDIpIC8gMjtcblxuICAgIHRoaXMucHJvcHMub25WaWV3cG9ydENoYW5nZSh7XG4gICAgICBkaXN0YW5jZTogbmV3RGlzdGFuY2VcbiAgICB9KTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gY3JlYXRlRWxlbWVudCgnZGl2Jywge1xuICAgICAgc3R5bGU6IHtwb3NpdGlvbjogJ3JlbGF0aXZlJywgdXNlclNlbGVjdDogJ25vbmUnfSxcbiAgICAgIG9uTW91c2VEb3duOiB0aGlzLl9vbkRyYWdTdGFydC5iaW5kKHRoaXMpLFxuICAgICAgb25Nb3VzZU1vdmU6IHRoaXMuX29uRHJhZy5iaW5kKHRoaXMpLFxuICAgICAgb25Nb3VzZUxlYXZlOiB0aGlzLl9vbkRyYWdFbmQuYmluZCh0aGlzKSxcbiAgICAgIG9uTW91c2VVcDogdGhpcy5fb25EcmFnRW5kLmJpbmQodGhpcyksXG4gICAgICBvbldoZWVsOiB0aGlzLl9vbldoZWVsLmJpbmQodGhpcyksXG4gICAgICBjaGlsZHJlbjogdGhpcy5wcm9wcy5jaGlsZHJlblxuICAgIH0pO1xuICB9XG59XG5cbk9yYml0Q29udHJvbGxlci5wcm9wVHlwZXMgPSBwcm9wVHlwZXM7XG5PcmJpdENvbnRyb2xsZXIuZGVmYXVsdFByb3BzID0gZGVmYXVsdFByb3BzO1xuIl19